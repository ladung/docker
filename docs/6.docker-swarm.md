# Docker swarm:
 - Docker swarm là công cụ điều phối docker container giúp nhóm các docker host riêng lẻ lại với nhau thành cluster.
 - Mỗi docker host kết nối đến tập hợp swarm đóng vai trò là manager hoặc worker và được gọi là một node.
   - Manager là node có nhiệm vụ quản lý và phân cấp các member. Nó là node được phép thực hiện các lệnh trong một swarm.
   - Worker là node mà chạy chế độ swarm. Nó chỉ nhận và thực hiện các lệnh từ manager.

   *Một docker host có thể là manager, worker hoặc cả 2 chức năng.*
 - Sử dụng TLS để bảo mật giao tiếp giữa các node, xác thực node và ủy quyền đúng vai trò các node.
 - Trong swarm, đối tượng để quản lý là services. Service định nghĩa cho một task được thực thi trong manager node hoặc worker node
 - `Service` có thể được triển khai theo hai hình thức:
   - `replicated services`: Swarm manager sẽ thực hiện phân phối một số lượng cụ thể giữa các bản sao của task so với số lượng node dựa trên quy mô ta mong muốn.
   - `global services`: Swarm chạy một task cho service trên mỗi node có sẵn trong cluser.
 - `Task or replica`: Một task giữ thông tin về một docker container và các lệnh để chạy bên trong container đó. Khi một task được gán vào một node, nó không thể chuyển đến node khác.

[]: # "Swarm:là một cluster của một hoặc nhiều Docker Engine đang run (cụ thể ở đây là các node) trong chế độ Swarm, thay vì phải chạy các container bằng câu lệnh thì ta sẽ thiết lập các services để phân bổ các bản replicas tới các node."


*When a container is wrapped in a service we call it a task or a replica, and the service construct adds things like scaling, rolling updates, and simple rollbacks.*

# Tạo một Swarm cluster
- Cài đặt docker trên các node:

		| STT | Hostname |   IP Address  |   OS   |
        | --- | -------- | ------------- | ------ |
        |  1  | manager  | 66.0.0.6      | CentOS |
        |  2  | worker7  | 66.0.0.7      | CentOS |
        |  3  | worker8  | 66.0.0.8      | CentOS |

*Mở port*

	- 2377/tcp: Giao tiếp giữa các manager node
	- 7946/tcp and 7946/udp: Giao tiếp giữa các node
	- 4789/udp: Cho phép các node giao tiếp qua VXLAN
- Khởi tạo swarm: `docker swarm init --advertise-addr 66.0.0.6:2377 --listen-addr 66.0.0.6:2377`
	- Trong đó: --advertise-addr: chỉ ra IP và port để các node khác connect tới manager.

				--advertise-addr: chỉ ra IP và port lắng nghe các swarm traffic.

- Kết quả: 

```sh
[root@manager ~]# docker swarm init --advertise-addr 66.0.0.6:2377 --listen-addr 66.0.0.6:2377
Swarm initialized: current node (homr2xzv9sbjikwki501phzhm) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-234j41s6sedz52fnxdt4m6tsu8c6vqz46pniw733cz5jub7tve-4dynnry5fmdt8l3o6wrmf8d77 66.0.0.6:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
```


- Nếu muốn thêm node manager khác, chạy lệnh `docker swarm join-token manager`. Sau khi chạy lệnh, ta chỉ cần copy dòng lệnh ở output vào chạy ở node manager muốn thêm.

- Liệt kê các node trong swarm:`docker node ls`

```sh
[root@manager ~]# docker node ls
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
9sliijv978kjlwvue9n7y2suy *   manager             Ready               Active              Leader              19.03.8
```

- Để join một node worker vào swarm:
	- Chạy lệnh để join woker vào swarm:`docker swarm join --token SWMTKN-1-234j41s6sedz52fnxdt4m6tsu8c6vqz46pniw733cz5jub7tve-4dynnry5fmdt8l3o6wrmf8d77 66.0.0.6:2377`

	*giá trị tocken là giá trị lúc tạo node manager*

	```sh
		[root@worker7 ~]# docker swarm join --token SWMTKN-1-234j41s6sedz52fnxdt4m6tsu8c6vqz46pniw733cz5jub7tve-4dynnry5fmdt8l3o6wrmf8d77 66.0.0.6:2377
		This node joined a swarm as a worker
	```

- Kiểm tra lại các node: 

```sh
[root@manager ~]# docker node ls
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
9sliijv978kjlwvue9n7y2suy *   manager             Ready               Active              Leader              19.03.8
76z56tu6woz1ujw5buhqg9z52     worker7             Ready               Active                                  19.03.8
o0isxvm97lvpak0za8bahfaj2     worker8             Ready               Active                                  19.03.8
```
